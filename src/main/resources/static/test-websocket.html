<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; }
        .log { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; background: #f5f5f5; }
        .log-entry { margin: 5px 0; }
        .info { color: blue; }
        .success { color: green; }
        .error { color: red; }
        input, button { margin: 5px; padding: 5px; }
    </style>
</head>
<body>
    <h1>WebSocket Test</h1>

    <div>
        <h3>1. í”Œë ˆì´ì–´ ì°¸ê°€</h3>
        <input type="text" id="playerId" placeholder="Player ID" value="player1">
        <button onclick="joinGame()">Join Game</button>
        <div>Room ID: <span id="roomId">-</span></div>
        <div>Color: <span id="playerColor">-</span></div>
    </div>

    <div>
        <h3>2. WebSocket êµ¬ë…</h3>
        <button onclick="connectWebSocket()">Connect WebSocket</button>
        <button onclick="disconnect()">Disconnect</button>
        <div>Status: <span id="wsStatus">Disconnected</span></div>
    </div>

    <div>
        <h3>3. í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡</h3>
        <button onclick="sendTestMessage()">Send Test to Topic</button>
    </div>

    <h3>ë¡œê·¸</h3>
    <div class="log" id="log"></div>

    <script>
        let stompClient = null;
        let currentRoomId = null;
        let currentPlayerColor = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function joinGame() {
            const playerId = document.getElementById('playerId').value;
            log('í”Œë ˆì´ì–´ ì°¸ê°€ ì‹œë„: ' + playerId);

            try {
                const response = await fetch('/api/game/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ playerId: playerId })
                });

                const data = await response.json();
                currentRoomId = data.roomId;
                currentPlayerColor = data.playerColor;

                document.getElementById('roomId').textContent = currentRoomId;
                document.getElementById('playerColor').textContent = currentPlayerColor;

                log('âœ… ì°¸ê°€ ì„±ê³µ! Room: ' + currentRoomId + ', Color: ' + currentPlayerColor, 'success');
                log('ì´ì œ "Connect WebSocket" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”');

            } catch (error) {
                log('âŒ ì°¸ê°€ ì‹¤íŒ¨: ' + error, 'error');
            }
        }

        function connectWebSocket() {
            if (!currentRoomId || !currentPlayerColor) {
                log('âŒ ë¨¼ì € ê²Œì„ì— ì°¸ê°€í•˜ì„¸ìš”!', 'error');
                return;
            }

            log('WebSocket ì—°ê²° ì‹œë„...');
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function(frame) {
                log('âœ… WebSocket ì—°ê²° ì„±ê³µ!', 'success');
                document.getElementById('wsStatus').textContent = 'Connected';

                // ìì‹ ì˜ ìƒ‰ìƒ í† í”½ êµ¬ë…
                const topic = '/topic/game.' + currentRoomId + '.' + currentPlayerColor;
                log('êµ¬ë… ì¤‘: ' + topic);

                stompClient.subscribe(topic, function(message) {
                    log('ğŸ“¥ ë©”ì‹œì§€ ìˆ˜ì‹ !', 'success');
                    log('ë‚´ìš©: ' + message.body);

                    try {
                        const data = JSON.parse(message.body);
                        log('íŒŒì‹± ì„±ê³µ: ' + JSON.stringify(data, null, 2));
                    } catch (e) {
                        log('íŒŒì‹± ì‹¤íŒ¨');
                    }
                });

                log('âœ… êµ¬ë… ì™„ë£Œ: ' + topic, 'success');
                log('ì´ì œ ë‹¤ë¥¸ ë¸Œë¼ìš°ì € íƒ­ì—ì„œ player2ë¡œ ì°¸ê°€í•´ë³´ì„¸ìš”!');

            }, function(error) {
                log('âŒ WebSocket ì—°ê²° ì‹¤íŒ¨: ' + error, 'error');
                document.getElementById('wsStatus').textContent = 'Error';
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
                log('WebSocket ì—°ê²° ì¢…ë£Œ');
                document.getElementById('wsStatus').textContent = 'Disconnected';
            }
        }

        async function sendTestMessage() {
            if (!currentRoomId || !currentPlayerColor) {
                log('âŒ ë¨¼ì € ê²Œì„ì— ì°¸ê°€í•˜ì„¸ìš”!', 'error');
                return;
            }

            const topic = '/topic/game.' + currentRoomId + '.' + currentPlayerColor;
            log('í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ ì¤‘: ' + topic);

            try {
                const response = await fetch('/api/test/ws?topic=' + encodeURIComponent(topic) + '&message=Test');
                const data = await response.json();
                log('âœ… í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ë¨: ' + JSON.stringify(data), 'success');
            } catch (error) {
                log('âŒ ì „ì†¡ ì‹¤íŒ¨: ' + error, 'error');
            }
        }
    </script>
</body>
</html>
